version: 0.2

env:
  variables:
    REPORT_BUCKET: simplecarrentalapp-devsecops-reports
    REPORT_PATH: SimpleCarRentalApp-P/reports
    SNS_TOPIC_ARN: arn:aws:sns:us-east-1:637061300326:SimpleCarRentalApp-CodeBuild-Notifications

phases:
  install:
    runtime-versions:
      java: corretto11
    commands:
      - echo Installing dependencies...
      - apt-get update
      - apt-get install -y unzip wget zip
      - wget https://github.com/jeremylong/DependencyCheck/releases/download/v8.4.0/dependency-check-8.4.0-release.zip
      - unzip dependency-check-8.4.0-release.zip -d /opt

  pre_build:
    commands:
      - echo Running OWASP Dependency-Check...
        pre_build:
    commands:
      - echo Running OWASP Dependency-Check...
      - |
        /opt/dependency-check/bin/dependency-check.sh \
          --project "SimpleCarRentalApp" \
          --scan . \
          --format HTML \
          --out $REPORT_PATH/dependency-check \
          --disableCentral


  build:
    commands:
      - echo Running Maven Build with JaCoCo...
      - mvn clean verify

  post_build:
    commands:
      - echo "Uploading JaCoCo and Dependency-Check reports to S3 with encryption..."
      - aws s3 cp target/site/jacoco/ s3://$REPORT_BUCKET/$REPORT_PATH/jacoco/ --recursive --sse AES256
      - aws s3 cp $REPORT_PATH/dependency-check/ s3://$REPORT_BUCKET/$REPORT_PATH/dependency-check/ --recursive --sse AES256

      - echo "Zipping JaCoCo report for easier navigation..."
      - zip -r jacoco-report.zip target/site/jacoco/

      - echo "Uploading zipped report to S3..."
      - aws s3 cp jacoco-report.zip s3://$REPORT_BUCKET/$REPORT_PATH/jacoco-report.zip --sse AES256

      - echo "Generating presigned URL for zipped report..."
      - export JACOCO_ZIP_URL=$(aws s3 presign s3://$REPORT_BUCKET/$REPORT_PATH/jacoco-report.zip --expires-in 86400)

      - echo "Generating presigned URL for Dependency-Check (SCA) report..."
      - export SCA_URL=$(aws s3 presign s3://$REPORT_BUCKET/$REPORT_PATH/dependency-check/dependency-check-report.html --expires-in 86400)


      - echo "Sending combined SNS notification with both report links..."
      - |
        export MESSAGE="‚úÖ CodeBuild succeeded for SimpleCarRentalApp.\n\nüì¶ Download full JaCoCo report (ZIP): $JACOCO_ZIP_URL\n\nüîç Dependency-Check Report (SCA): $SCA_URL"
        aws sns publish \
          --topic-arn "$SNS_TOPIC_ARN" \
          --subject "‚úÖ CodeBuild Success: All Reports Ready" \
          --message "$MESSAGE"


reports:
  jacoco:
    files:
      - target/site/jacoco/index.html
    base-directory: target/site/jacoco
    discard-paths: yes

artifacts:
  files:
    - target/*.war
    - target/site/jacoco/**/*
  discard-paths: no
